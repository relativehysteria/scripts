#!/bin/sh

set -eu

SOUNDBOARD_SINK="soundboard"
MIX_SINK="${SOUNDBOARD_SINK}_mix"
SOUNDBOARD_DEVICE="pulse/${SOUNDBOARD_SINK}"
STATE_FILE="/tmp/soundboard_mic"

# helper to run pactl safely
p() {
    if ! pactl "$@"; then
        echo "Error running: pactl $*" >&2
        exit 1
    fi
}

# helper to check that pactl exists and we are able to use it
check_system_compatibility() {
    command -v pactl >/dev/null 2>&1 || {
        echo "Error: pactl not found." >&2
        exit 1
    }

    pactl info >/dev/null 2>&1 || {
        echo "Error: Unable to connect to PulseAudio/PipeWire-Pulse." >&2
        exit 1
    }
}

# let the user select a microphone
pick_microphone() {
    mics=$(pactl list short sources | awk '!/monitor/ {print $2}')
    [ -z "$mics" ] && {
        echo "Error: No physical microphones found." >&2
        exit 1
    }

    # if onlye one exists, auto-select it
    count=$(printf "%s\n" "$mics" | wc -l)
    if [ "$count" -eq 1 ]; then
        printf "%s" "$mics"
        return
    fi
    chosen=$(printf "%s\n" "$mics" | wmenu)
    [ -z "$chosen" ] && exit 1
    printf "%s" "$chosen"
}

################################################################################
### FLAG HANDLING ##############################################################
################################################################################

DISABLE_MIC=false

while [ $# -gt 0 ]; do
    case "$1" in
        --disable-mic)
            DISABLE_MIC=true
            ;;
        --help|-h)
            echo "Usage: $0 [--disable-mic]"
            exit 0
            ;;
        *)
            echo "Unknown option: $1" >&2
            exit 1
            ;;
    esac
    shift
done

################################################################################
### START MIXER ###############################################################
################################################################################

# toggle on the mixer
start_mixer() {
    echo "Starting soundboard mixer…"

    DEFAULT_SINK=$(pactl get-default-sink)
    DEFAULT_MIC_SRC=$(pactl get-default-source)

    # let the user choose a mic if multiple exist
    if [ "$DISABLE_MIC" = false ]; then
        MIC_SOURCE=$(pick_microphone)
    fi

    # load sinks
    SOUNDBOARD_SINK_ID=$(p load-module module-null-sink \
        sink_name="$SOUNDBOARD_SINK" \
        sink_properties=device.description="Soundboard File Input" \
        | tr -d '\n')

    MIX_SINK_ID=$(p load-module module-null-sink \
        sink_name="$MIX_SINK" \
        sink_properties=device.description="Soundboard Mic" \
        | tr -d '\n')

    # create loopbacks
    if [ "$DISABLE_MIC" = false ]; then
        LB_MIC_TO_MIX=$(p load-module module-loopback \
            source="$MIC_SOURCE" \
            sink="$MIX_SINK" latency_msec=50 | tr -d '\n')
    else
        LB_MIC_TO_MIX=""
    fi

    LB_SBD_TO_MIX=$(p load-module module-loopback \
        source="$SOUNDBOARD_SINK.monitor" \
        sink="$MIX_SINK" latency_msec=50 | tr -d '\n')

    LB_SBD_TO_SYS=$(p load-module module-loopback \
        source="$SOUNDBOARD_SINK.monitor" \
        sink="$DEFAULT_SINK" latency_msec=50 | tr -d '\n')

    # lowe the volume of soundboard -> speakers loopback
    SINK_INPUT_ID=$(pactl list sink-inputs \
        | grep -i -B 2 "owner module: $LB_SBD_TO_SYS" \
        | head -1 \
        | sed 's/^Sink Input #//')

    [ -n "$SINK_INPUT_ID" ] && p set-sink-input-volume "$SINK_INPUT_ID" "80%"

    VIRTUAL_MIC_ID=$(p load-module module-remap-source \
        master="$MIX_SINK.monitor" \
        source_name="${SOUNDBOARD_SINK}_mic" \
        source_properties=device.description="SOUNDBOARD")

    {
        echo "# auto-generated"
        echo "SOUNDBOARD_SINK_ID=$SOUNDBOARD_SINK_ID"
        echo "MIX_SINK_ID=$MIX_SINK_ID"
        echo "LB_MIC_TO_MIX=$LB_MIC_TO_MIX"
        echo "LB_SBD_TO_MIX=$LB_SBD_TO_MIX"
        echo "LB_SBD_TO_SYS=$LB_SBD_TO_SYS"
        echo "DEFAULT_MIC_SRC=$DEFAULT_MIC_SRC"
        echo "VIRTUAL_MIC_ID=$VIRTUAL_MIC_ID"
        echo "SOUNDBOARD_DEVICE=$SOUNDBOARD_DEVICE"
    } > "$STATE_FILE"

    p set-default-source "${SOUNDBOARD_SINK}_mic"

    echo "Soundboard mixer started."
    echo "Virtual mic active: ${SOUNDBOARD_SINK}_mic"
    echo "Play audio to $SOUNDBOARD_DEVICE"
}

################################################################################

stop_mixer() {
    [ ! -f "$STATE_FILE" ] && {
        echo "Nothing to stop."
        exit 0
    }

    echo "Stopping soundboard mixer…"
    . "$STATE_FILE"

    pactl unload-module "$LB_SBD_TO_SYS"  >/dev/null 2>&1 || true
    pactl unload-module "$LB_SBD_TO_MIX"  >/dev/null 2>&1 || true
    [ -n "$LB_MIC_TO_MIX" ] && pactl unload-module "$LB_MIC_TO_MIX" >/dev/null 2>&1 || true
    pactl unload-module "$MIX_SINK_ID"    >/dev/null 2>&1 || true
    pactl unload-module "$SOUNDBOARD_SINK_ID" >/dev/null 2>&1 || true
    pactl unload-module "$VIRTUAL_MIC_ID" >/dev/null 2>&1 || true

    if [ -n "${DEFAULT_MIC_SRC:-}" ]; then
        pactl set-default-source "$DEFAULT_MIC_SRC" >/dev/null 2>&1 || true
        echo "Restored default mic: $DEFAULT_MIC_SRC"
    fi

    rm -f "$STATE_FILE"
    echo "Soundboard mixer disabled."
}

################################################################################

check_system_compatibility

if [ -f "$STATE_FILE" ]; then
    stop_mixer
else
    start_mixer
fi
