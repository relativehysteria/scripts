#!/bin/sh

INPUT="$1"
OUTPUT="compressed.mp4"

if [ -z "$INPUT" ]; then
    echo "Usage: $0 input_video"
    exit 1
fi

# ---------- SETTINGS ----------

MAX_SIZE_MB=9.3          # Extra safety for higher audio
AUDIO_KBPS=96            # High-quality AAC
PRESET="slow"
TUNE="film"
PIXEL_BITRATE_MIN=0.07   # Allow more downscaling

# --------------------------------

# Duration
DURATION=$(ffprobe -v error -show_entries format=duration \
    -of default=noprint_wrappers=1:nokey=1 "$INPUT")

# Frame rate
FPS=$(ffprobe -v error -select_streams v:0 \
    -show_entries stream=r_frame_rate \
    -of default=noprint_wrappers=1:nokey=1 "$INPUT" | bc -l)

# Resolution
WIDTH=$(ffprobe -v error -select_streams v:0 \
    -show_entries stream=width \
    -of default=noprint_wrappers=1:nokey=1 "$INPUT")
HEIGHT=$(ffprobe -v error -select_streams v:0 \
    -show_entries stream=height \
    -of default=noprint_wrappers=1:nokey=1 "$INPUT")

# Bitrate budget
TOTAL_BITS=$(echo "$MAX_SIZE_MB * 1000 * 1000 * 8" | bc)
VIDEO_BITS=$(echo "$TOTAL_BITS - ($AUDIO_KBPS * 1000 * $DURATION)" | bc)
VIDEO_KBPS=$(echo "$VIDEO_BITS / $DURATION / 1000" | bc)

# Bits-per-pixel
BPP=$(echo "$VIDEO_KBPS * 1000 / ($WIDTH * $HEIGHT * $FPS)" | bc -l)

# Scale if needed
VF=""
if (( $(echo "$BPP < $PIXEL_BITRATE_MIN" | bc -l) )); then
    SCALE_FACTOR=$(echo "sqrt($BPP / $PIXEL_BITRATE_MIN)" | bc -l)
    NEW_W=$(echo "$WIDTH * $SCALE_FACTOR / 2 * 2" | bc)
    VF="-vf scale=$NEW_W:-2"
fi

# ---------- PASS 1 ----------
ffmpeg -y -i "$INPUT" \
    $VF \
    -c:v libx264 \
    -b:v "${VIDEO_KBPS}k" \
    -maxrate "${VIDEO_KBPS}k" \
    -bufsize "$((VIDEO_KBPS * 2))k" \
    -preset $PRESET \
    -tune $TUNE \
    -pass 1 \
    -an \
    -f mp4 /dev/null

# ---------- PASS 2 ----------
ffmpeg -i "$INPUT" \
    $VF \
    -c:v libx264 \
    -b:v "${VIDEO_KBPS}k" \
    -maxrate "${VIDEO_KBPS}k" \
    -bufsize "$((VIDEO_KBPS * 2))k" \
    -preset $PRESET \
    -tune $TUNE \
    -pass 2 \
    -c:a aac -b:a ${AUDIO_KBPS}k \
    -movflags +faststart \
    "$OUTPUT"

rm -f ffmpeg2pass-0.log ffmpeg2pass-0.log.mbtree
