#!/bin/sh

soundboard_dev=$(grep "SOUNDBOARD_DEVICE" /tmp/soundboard_mic  2>/dev/null | tr '=' ' ' | awk '{print $2}')
soundboard_dir="$HOME/.local/share/soundboard"
state="/tmp/current_sound"

# Check that a soundboard is on
[ "$soundboard_dev" = "" ] && echo "No soundboard." && exit

# If we weren't given a file name, select one from the soundboard directory
if ! [ "$1" = "" ]; then
    file="$1"
else
    file=$(ls "$soundboard_dir" | wmenu -i)
fi

# If we have no filename, bail out
[ "$file" = "" ] && exit

# If the filename starts with "./", play the relatively-pathed file, else play a
# file from the soundboard directory
if [ "${file#./}" != "$file" ]; then
    file="$PWD/$file"
else
    file="$soundboard_dir/$file"
fi

# If there's a PID stored, and it's running, kill it
if [ -f "$state" ]; then
    old_pid=$(cat "$state")
    if [ -n "$old_pid" ] && kill -0 "$old_pid" 2>/dev/null; then
        kill "$old_pid"

        # optional: force kill after short delay
        sleep 0.1
        kill -9 "$old_pid" 2>/dev/null
    fi
fi

# Start new mpv
mpv --audio-device="pulse/soundboard" "$file" &
new_pid=$!
echo "$new_pid" > "$state"

# Wait for mpv to finish
wait "$new_pid"

# Clean up (only remove if it still matches)
if [ "$(cat "$state" 2>/dev/null)" = "$new_pid" ]; then
    rm -f "$state"
fi
