#!/bin/sh

# exit on error or undefined variable
set -eu

SOUNDBOARD_SINK="soundboard"
MIX_SINK="${SOUNDBOARD_SINK}_mix"
STATE_FILE="/tmp/soundboard_mic"

# Helper to run pactl safely
p() {
    if ! pactl "$@"; then
        echo "Error running: pactl $*" >&2
        exit 1
    fi
}


# Helper to check that pactl exists and we are able to use it
check_system_compatibility() {
    command -v pactl >/dev/null 2>&1 || {
        echo "Error: pactl not found." >&2
        exit 1
    }

    pactl info >/dev/null 2>&1 || {
        echo "Error: Unable to connect to PulseAudio/PipeWire-Pulse." >&2
        exit 1
    }
}


# Let the user select a microphone
pick_microphone() {
    mics=$(pactl list short sources | awk '!/monitor/ {print $2}')
    [ -z "$mics" ] && {
        echo "Error: No physical microphones found." >&2
        exit 1
    }

    # If only one mic exists, auto-select it
    count=$(printf "%s\n" "$mics" | wc -l)
    if [ "$count" -eq 1 ]; then
        printf "%s" "$mics"
        return
    fi

    chosen=$(printf "%s\n" "$mics" | wmenu)
    [ -z "$chosen" ] && exit 1
    printf "%s" "$chosen"
}


# Toggle on the mixer
start_mixer() {
    echo "Starting soundboard mixer…"

    DEFAULT_SINK=$(pactl get-default-sink)
    DEFAULT_MIC_SRC=$(pactl get-default-source)

    # Let user choose a mic if multiple exist
    MIC_SOURCE=$(pick_microphone)

    # Load sinks
    SOUNDBOARD_SINK_ID=$(p load-module module-null-sink \
        sink_name="$SOUNDBOARD_SINK" \
        sink_properties=device.description="Soundboard File Input" \
        | tr -d '\n')

    MIX_SINK_ID=$(p load-module module-null-sink \
        sink_name="$MIX_SINK" \
        sink_properties=device.description="Soundboard Mic" \
        | tr -d '\n')

    # Create loopbacks
    LB_MIC_TO_MIX=$(p load-module module-loopback \
        source="$MIC_SOURCE" \
        sink="$MIX_SINK" latency_msec=50 | tr -d '\n')

    LB_SBD_TO_MIX=$(p load-module module-loopback \
        source="$SOUNDBOARD_SINK.monitor" \
        sink="$MIX_SINK" latency_msec=50 | tr -d '\n')

    LB_SBD_TO_SYS=$(p load-module module-loopback \
        source="$SOUNDBOARD_SINK.monitor" \
        sink="$DEFAULT_SINK" latency_msec=50 | tr -d '\n')

    # Lower volume of soundboard -> speakers loopback
    SINK_INPUT_ID=$(pactl list sink-inputs \
        | grep -i -B 2 "owner module: $LB_SBD_TO_SYS" \
        | head -1 \
        | sed 's/^Sink Input #//')

    [ -n "$SINK_INPUT_ID" ] && p set-sink-input-volume "$SINK_INPUT_ID" "80%"

    # Save state
    {
        echo "# auto-generated"
        echo "SOUNDBOARD_SINK_ID=$SOUNDBOARD_SINK_ID"
        echo "MIX_SINK_ID=$MIX_SINK_ID"
        echo "LB_MIC_TO_MIX=$LB_MIC_TO_MIX"
        echo "LB_SBD_TO_MIX=$LB_SBD_TO_MIX"
        echo "LB_SBD_TO_SYS=$LB_SBD_TO_SYS"
        echo "DEFAULT_MIC_SRC=$DEFAULT_MIC_SRC"
    } > "$STATE_FILE"

    # Apply virtual mic
    p set-default-source "$MIX_SINK.monitor"

    echo "Soundboard mixer started."
    echo "Now using virtual mic: $MIX_SINK.monitor"
    echo "Play audio to: pulse/$SOUNDBOARD_SINK"
}


# Toggle off the mixer
stop_mixer() {
    [ ! -f "$STATE_FILE" ] && {
        echo "Nothing to stop."
        exit 0
    }

    echo "Stopping soundboard mixer…"

    . "$STATE_FILE"

    # Unload modules (ignore errors)
    pactl unload-module "$LB_SBD_TO_SYS"  >/dev/null 2>&1 || true
    pactl unload-module "$LB_SBD_TO_MIX" >/dev/null 2>&1 || true
    pactl unload-module "$LB_MIC_TO_MIX" >/dev/null 2>&1 || true
    pactl unload-module "$MIX_SINK_ID"   >/dev/null 2>&1 || true
    pactl unload-module "$SOUNDBOARD_SINK_ID" >/dev/null 2>&1 || true

    # Restore original mic
    if [ -n "${DEFAULT_MIC_SRC:-}" ]; then
        pactl set-default-source "$DEFAULT_MIC_SRC" >/dev/null 2>&1 || true
        echo "Restored default mic: $DEFAULT_MIC_SRC"
    fi

    rm -f "$STATE_FILE"

    echo "Soundboard mixer disabled."
}

################################################################################

check_system_compatibility

if [ -f "$STATE_FILE" ]; then
    stop_mixer
else
    start_mixer
fi
